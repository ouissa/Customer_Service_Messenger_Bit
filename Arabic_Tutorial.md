# إنشاء روبوت دردشة باستخدام wit.ai،meseenger و واجهة برمجة التطبيقات (Facebook marketing API)

في هذا الدليل التعليمي سننشئ روبوتا للدردشة على Messenger لشركة تبيع القمصان. يجيب هذا الروبوت على أسئلة العملاء حول المنتجات المتوفرة و الأحجام و الألوان و الأسعار. يعتمد الروبوت على كتالوج الشركة الموجود لدى فيسبوك ويقترح المنتجات وفقا له. المتطلبات المسبقة: يفترض هذا الدليل التعليمي التالي: لديك كتالوج فيسبوك لمنتجاتك المرتبطة بحساب الأعمال. لديك معرفة عن أساسيات NodeJS. لديك منصة تجارية إلكترونية. ما هو Facebook marketing API: هي واجهة برمجة التطبيقات، تستمد إلى HTTP من أجل الاستعلام عن البيانات برمجيا و إنشاء الإعلانات و إدارتها و تنفيذ مجموعة متنوعة من المهام الأخرى. من أجل استخدام Facebook marketing API يجب أن تكون لديك معرفة أساسية ب Facebook graph API و كيفية استخدامه و يمكنك أن تجد ذلك هنا.

### **ما هو wit.ai؟ و كيف يعمل؟**

wit.ai هو محرك للبرمجة اللغوية العصبية يسمح بإنشاء تطبيقات و أجهزة المحادثة التي بإمكانك التحدث إليها أو إرسال رسائل نصية إليها. فهو يوفر واجهة سهلة للتعلم السريع و فهم تواصل البشر كما يساعد على تحليل الرسالة المعقدة (التي يمكن أن تكون إما صوتية أو نصية) في بيانات منظمة.

تعتمد عملية تدريب wit.ai على ثلاثة عناصر أساسية:

**الألفاظ (utterances):** وهي الأسئلة و العبارات التي يسألها المستخدم. قد يكون هذا السؤال في صيغة إجراء يريد المستخدم القيام به، أو معلومات يريد المستخدم معرفتها.



![img](https://lh4.googleusercontent.com/SBOcOJI0FpTEyeVP0fkVLm5a_r6u0tFl75PhQg9TvrY1aR3PQ3SXinjLDk3Sjcd0yjODeOICsexQhIEewAMuG8x-oI4v23mqNgMPKa2SIbzAnm_VCgIFwCu0KHZQh-rvD5sD0nnO)



**النوايا (intents):** وهي تمثل الغرض من طرح السؤال، على سبيل المثال الغرض أو النية من طرح السؤال "كم سعر قميص فيسبوك الأزرق؟" هو معرفة السعر.



![img](https://lh4.googleusercontent.com/FyT0u5BevPvWNv2pokDEzochiIL_iLmTJKp14gLd-yEtcBTCKbk9DE1ub4P5rut_vGwwjeVBpLZUEcs4uzJyr3HiDqw27Q5hmGFyy_10M0W6TOm43qiaPIv0hsc794Pado8IwGof)



**الفئات (Entities):** و هي تشكل جزء مهما من عملية تدريب روبوت الدردشة، فالفئات هي عبارة عن كلمات مفتاحية تتضمنها الألفاظ و تساعد على فهم السؤال و تحديد غرضه (النوايا). في المثال السابق عبارة "كم سعر" تمكننا من فهم القصد من السؤال، وعليه يمكننا أن ندرجها في فئات الكلمات المفتاحية للسؤال عن السعر.



![img](https://lh5.googleusercontent.com/eNe7kQgyFxQkhrLXYi9WZ1NC8gdB7ETZrHZGHA1YcM-91UOjDaEzQCG4Wk4zRTC9UGRIa1hHcdJQ-fah8C8_Y0RJTX1r9Vd62g8rnRPQj1dza3MlWoa3dn7NHA9t4yMEY-wAVo-O)



### **تدريب روبوت الدردشة:**

1. **إنشاء تطبيق Wit.ai****:**

قبل أن تمكن من تدريب روبوت الدردشة علينا أولا أن ننشئ تطبيقا على Wit.ai.

- اذهب إلى الرابط [https://wit.ai](https://wit.ai/) وقم بتسجيل الدخول باستخدام حساب فيسبوك أو GitHub؛



![img](https://lh6.googleusercontent.com/up9oDLHcbhCU5xXpaWFEeccPUMt1_I24ddt3vIXfnSYQKkGiidRJXKEepV3uMy9w9H4BhF1a9B4BfBRW4l_AiQXJQdqCmPlm27Mxrj1-udZu4MHm20_uLiINFIS5uR_-Dv7duCHf)

- انقر على "تطبيق جديد" (new app) من أجل إنشاء تطبيق جديد؛
- اختر اسما للتطبيق و اللغة التي ستستخدمها لتدريب روبوت الدردشة؛
- انقر إنشاء (create).

![img](https://lh5.googleusercontent.com/qk5_3SPog1su4PQIYYCpnIKTfl_hN9kDOSZAcDMvnfISusFiAj3lIXevvv07Jg-fbC60mPYFjP0gQblqW65vSZ7-lZRUXg89dMERIAJoziCttpRmlQ8seHDbScKoMaUvUS0CAHXb)



أول شيء نراه بعد إنشاء التطبيق هو منطقة نصية تقول "ادخل لفظا…" (type your utterance). في هذه المنطقة، سنقوم بإدخال الأسئلة التي ستدرب روبوت الدردشة. على الجانب الأيسر نجد قائمة تحتوي على مختلف أجزاء التطبيق من مثال الفئات و التي تحتوي كل الفئات التي ننشئها أثناء التدريب.

1. **تدريب الروبوت:**

لتدريب الروبوت، نحتاج إلى طرح الأسئلة التي قد يطرحها المستخدم في المنطقة النصية المخصصة للألفاظ (utterances). لتحديد الغرض أو النية (intent) من سؤال ما، يجب علينا إضافته في المنطقة النصية الواقعة تحت سابقتها للألفاظ. كما يجدر التنويه إلى أنه بعد تدريب الروبوت على بعض الأسئلة سيقوم Wit.ai بتحديد النية أتوماتيكيا. أخيرا ومن أجل إضافة الفئات التي تتواجد بسؤال ما يجب تمييز الكلمة المفتاحية و تعيينها للفئة المناسبة أو إنشاء فئة جديدة. بعد التأكد من كل هذه المراحل، يمكنك النقر على (train and validate).



![img](https://lh4.googleusercontent.com/uWsMuZhmw69jS7t-Uk3rLiy9cJ6IDuKjMGMKJTpDm8kYQk5tuDeQurLxeFan83M9Y87P3QLqwGeNsRhmFaXs6ha4KjD1rmhPQQen5YccyjD0oViTjl5Ucr84bHA58-xt1qTKzCqG)



في هذا الدليل التعليمي سنعمل على تدريب روبوت دردشة لشركة أقمصة بغية تقديم دعم أفضل لزبنائها.

في هذا المثال، سنفترض أن الروبوت سيتعامل مع ثلاث نوايا و التي قد يتضمنها سؤال الزبون.

1. السؤال عن توفر القمصان بالمعايير التي يحددها الزبون (asking for availability)؛
2. السؤال عن السعر (asking for price)؛
3. السؤال عن طرق دفع ثمن الأقمصة (asking for methods of payments).



1. #### **السؤال عن توفر القمصان:**

لنأخذ السؤال التالي كمثال: هل تتوفرون على قميص نسائي وردي اللون و طويل الأكمام؟

يمكن التمييز بين أربعة فئات في هذا السؤال:

- **لون القميص (t-shirt color):** في السؤال أعلاه لدينا كلمة وردي و التي تمثل فئة لون القميص. كما يجدر الإشارة إلى كون wit.ai يسمح بإضافة كلمات مفتاحية أخرى لنفس الفئة و ذلك بالنقر على الفئات (entities) على يسار الشاشة و من ثم النقر على الفئة التي نود إضافة كلمات مفتاحية فيها. أخيرا ننقر على أضف كلمة مفتاحية (add a keyword) و نضيف كلمة مفتاحية ك"أزرق" في فئة لون القميص.
- **نوع الأكمام (sleeves types):** في المثال لدينا عبارة "طويل الأكمام" تمثل فئة نوع الأكمام. من بعض الكلمات المفتاحية التي يمكن إضافتها في هذه الفئة، نجد: قصير الأكمام، بلا أكمام، إلخ.
- **الجنس (gender):** في المثال لدينا كلمة نسائي تمثل هذه الفئة.
- **التوفر (availability):** كلمة تتوفرون في السؤال هي كلمة مفتاحية تنتمي لفئة التوفر. إضافة إلى ذلك فإن هذه الفئة تعتبر ذات أهمية بالغة في تحديد القصد أو النية من سؤال الزبون.

لضمان أفضل أداء لروبوت الدردشة، يستحسن تدريبه على أكبر عدد ممكن من الألفاظ من مثال:

- ما هي الخيارات الرخيصة بالنسبة للأقمصة المخصصة للنساء؟
- هل أقمصة الأطفال متوفرة؟
- هل تبيعون أقمصة بأكمام قصيرة؟
- هل تتوفرون على أقمصة يزيد سعرها عن 70 درهما مغربيا؟
- ما هي الخيارات المتوفرة إذا أردت شراء قميص لطفل حديث الولادة؟
- هل تتوفر لديكم أقمصة ذات المقاس المتوسط؟
- هل أستطيع إيجاد قميص باللون البنفسجي في شركتكم؟
- هل تتوفر لديكم الأقمصة ذات المقاس الكبير؟
- هل تتوفر لديكم أقمصة ذات المقاس الصغير؟
- هل بإمكاني أن أجد لديكم قمصانا للأطفال الصغار؟
- ما هي الخيارات مرتفعة السعر بالنسبة لأقمصة الرجال؟
- ما هي الخيارات متوسطة السعر بالنسبة لأقمصة الرجال؟
- هل تبيعون أقمصة بسعر 40 درهم؟

1. **السؤال عن السعر:**

بالنسبة لهذا الغرض يمكن أن يكون لدينا أسئلة مشابهة لما يلي:

- ما هو سعر قميص فيسبوك الأزرق؟ (الفئات: ask_price: "ما هو سعر"، t-shirt_title: "قميص فايسبوك الأزرق")؛
- كم تكلفة قميص فيسبوك الأزرق: (الفئات: ask_price: "كم تكلفة"، t-shirt_title: "قميص فيسبوك الأزرق").

1. #### **السؤال عن طرق الدفع:**

بالنسبة لهذا الغرض يمكن أن يكون لدينا أسئلة مشابهة لما يلي:

- هل يمكنني دفع ثمن القميص بالفيزا كارت؟ (الفئات: payment: "هل يمكنني دفع ثمن"، method_of_payment: "الفيزا كارت")؛
- كيف يمكنني أن أدفع ثمن القميص؟ (الفئات: payment: "كيف يمكنني أن أدفع ثمن")



### **كيف للروبوت أن يجيب على الأسئلة؟**

قد تتساءل الآن إذا كان الروبوت يستطيع فهم الجمل التي يتلقاها من الزبون فضلا عن ربطها بأحد النوايا، كيف بإمكانه الاجابة؟

سنقوم ببناء واجهة برمجة التطبيقات (API) لهذا الغرض. ستقوم الواجهة بربط تطبيق الويت wit الذي يحتوي على كل النوايا والفئات مع الدردشة أو الشات chat في الماسنجر messenger. بالإضافة لهذا تحتوي الواجهة على كود code الوظائف functions الخاصة بكل نيه من النوايا.

بخلاصة يتم الأمر بالطريقة الموالية: 

1.  يقوم الزبون بطرح السؤال في الشات.
2.  تستمع واجهة التطبيقات، وتستلم سؤال الزبون.
3.  يقوما الويت بالتعرف على نية السؤال.
4.  تحدد الواجهة الوظيفية function لنية المتعرف عليها في السؤال. 
5. \- الاجابة المحصل عليها من الوظيفة ترسل إلى الشات على شكل رسالة من الروبوت.

للقيام بربط الويت و الماسنجر ننصح بمشاهدة هذا الفيديو المقدم من طرف فيسبوك Facebook والذي يبين كيفية الربط بين المسنجر و الويت باستعمال سيرفر نود Node Server المستضاف على منصة قلتش Glitch.

ما تبقى من هذا الدليل مبني على الكود المستعمل في الفيديو. أنقر هنا للحصول على الكود من غليتش. يمكنك استعمال خاصية روميكس Remix للحصول على نسخة منه يمكنك استعمالها. 

بعد أن شاهدت الفيديو و قمت بتعبئة كل متغيرات البيئة environment variables)، ما ستهتم به من الآن فصاعدا هو ملف wit handler.js حيث يتواجد الكود اللازم من أجل النوايا.

تاخذ الوظيفة responseFromWit(data) معامل هذا المعامل data : عبارة عن شيء json وتستعمل لاستخلاص النية في الرسالة المتلقاة من خلال المفتاح.

نستعمل التغيير switch لمناداة الوظيفة الملائمة لكل نية من النوايا.في حالة عدم التعرف على اي نية، نستعمل هذه الوظيفة handleGebbrish() يمكننا مثلا في هذه الحالة الرد على الزبون باقتراح المنتوجات الأكثر طلبا. 

و هكذا تكون الوظيفة على الشكل التالي:

```javascript
function responseFromWit(data) {
  console.log("data from wit:");
  console.log(JSON.stringify(data));

  const intent = (data.intents.length > 0 && data.intents[0]) || "__foo__";

  switch (intent.name) {
    case "asking_for_price":
      return askingForPrice(data);
    case "asking_for_availability":
        return askingForAvailability(data)
    case "asking_for_payment":
      return askingForPayment(data)
  }

  return handleGibberish();
}
```



لنقم الان بنظره عن كثب على وظيفة ما من الوظائف التي تهتم بالاجابة على احد النوايا. سنأخذ نية السؤال عن السعر ا

#### **السؤال عن السعر:**

فيما يخص هذه النية، نحتاج إلى التعرف على اسم منتج ما، أو قميص ما في حالتنا هذه، ثم الاجابة بسعر هذا القميص. على سبيل المثال، إذا تساءل الزبون "ما ثمن قميص الفيسبوك الأزرق" نهتم ب "قميص الفيسبوك" لأنها تمثل الإسم المستخدم في البحث عن القميص بإيجاد ثمنه. لإستخلاص هذا الاسم من رسالة الزبون، نستخدم مفتاح من الشيء.

كل ما تبقى الآن هو الرد بإجابة سليمة تتوافق مع مبتغى الزبون ولهذا الغرض سنستعمل واجهة برمجة التطبيقات للماركوتينغ للفيسبوك. أنقر هنا لمعلومات أكثر 

لاستعمال واجهة فيسبوك، نحتاج إلى:

- **رمز الكتالوج** يمكنك الحصول عليه من رابط الكتالوج

-  **رمز وصول الفيسبوك** يمكنك الحصول على رمز الوصول بطرق عديدة تجدها على الرابط التالي

 سنقوم بارسال طلباتها او على نقطة النهاية و لغربلة المعلومات، سنستعمل قواعد الغربلة المحددة هنا 

لإرسال طلب إلى واجهة تطبيقات الفيسبوك، نحتاج إلى ثلاث معلمات parameters: 

- **رمز الوصول.**
- **المجالات** **fields** و يشير إلى مختلف خصائص (المنتوج أو القميص في حالتنا) المستعملة. 

 فمثلا، إذا أردنا الحصول على سعر منتج باسم المعين علينا إدراج مجال السعر لأننا نريده كجواب من واجهه الماركوتينغ، ثم مجال الاسم لنستعمله لغربلة المنتجات بغية الحصول على سعرالمنتج الحامل لذلك الاسم فقط.

 **الغربال**: يحتوي الغربال على قاعدة الغربلة، في حالتنا هذه، نريد القميص ذو الاسم قميص  "i_contains" الفيسبوك"، إذن ستستعمل قاعدة : 

اذن من اجل السؤال على السعر، نستعمل الكود التالي:

```javascript
if(price != null && shirt_title != null){
 const response = await axios.get(`https://graph.facebook.com/${catalog_id}/products`, {
    params: {
        access_token,
        fields: ["name", "price"],
        filter: {
            name: {
              "i_contains": shirt_title[0].body
            }
         }
    }
  })
 }
```

هكذا نكون قد أنهينا كتابه الوظيفه من اجل نية السؤال عن السعر.

في بعض الاحيان، نحتاج الى جمع العديد من قواعد الغربلة في طلب واحد. فمثلا عندما يسأل الزبون عن الأقمصة النسائية المتوفره بثمن 100 درهم علينا الاجابة بالمنتجات التي تحقق التالي:

الجنس: أنثى 

الثمن: 100 

للقيام بهذا سنستعمل القواعد and و or. 

 و لاجابه الزبون من باقتراحات الأقمصة، من الافضل استعمال روابط هذه الأقمصة لتوجيه الزبون  إلى موقع المنتجات.

```javascript
      const response = await axios.get(
      `https://graph.facebook.com/${catalog_id}/products`,
        {
          params: {
            access_token,
            fields: ["url", "gender", "color"],
            filter: {
              and: [
                {
                  color: {
                    i_contains: shirt_color[0].body
                  }
                },
                {
                  gender: {
                    eq: gender[0].body
                  }
                }
              ]
            }
          }
        }
      );
```

### **ما يمكن إضافته**

**:**

- قواعد أكثر من أجل نوايا أكثر تعقيدا.
- الإجابة باستعمال نطاقات أسعار عوض سعر واحد ثابت
- استعمال التعبيرات العادية (regular expressions) للإجابة على أكبر قدر من الأسئلة.
- اقتراح منتوجات شبيهة في حالة عدم توفر نتائج البحث

هكذا نكون قد أنهينا كتابه الوظيفه من اجل نية السؤال عن السعر.

### **المصادر**

[الويت wit](https://wit.ai/docs)

[واجهة برمجة التطبيقات الماركوتينغ لفايسبوك](https://developers.facebook.com/docs/marketing-api/reference/product-catalog/products/)

[فيديو من طرف فايسبوك](

في حالة كان النص غير مرتبا لأنه بالعربية، المرجو الذهاب إلى [هنا])(https://docs.google.com/document/d/1MNRFgZ11qouBEOCyabCMZE9SOlxd2K7t8qIQqprX5VU/edit?usp=sharing) من أجل تجربة أحسن



